---
title: "Service Workerã¨Wasmã‚’çµ„ã¿åˆã‚ã›ã¦ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã§ãƒªã‚¢ãƒ«ã«å†ç¾ã™ã‚‹"
emoji: "ğŸ‘¨â€ğŸ’»"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["wasm", "service-worker", "webassembly", "php"]
published: true
---

ä»Šå›ã®è©±ã¯`Wasm`ã¨ã„ã†ã‚ˆã‚Šã‚‚`Service Worker`ã®è©±ãŒãƒ¡ã‚¤ãƒ³ã«ãªã‚Šã¾ã™ãŒã€`Wasm`ã¨`Service Worker`ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ä¸Šã§ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ã‚’ãƒªã‚¢ãƒ«ã«å†ç¾ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã€ã“ã®ã‚¿ã‚¤ãƒˆãƒ«ã«ã—ã¦ã„ã¾ã™ã€‚

ã¾ãšã¯å‹•ç”»ã‚’ã”è¦§ãã ã•ã„ã€‚

@[tweet](https://twitter.com/steelydylan/status/1671051881723105280)

è¦‹ã¦ã„ãŸã ãã¨åˆ†ã‹ã‚‹ã‚ˆã†ã«ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ä¸Šã§PHPã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¨ãã®å®Ÿè¡ŒçµæœãŒå³å´ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚
ç‰¹ã«é¢ç™½ã„ç‚¹ãŒã€ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã®POSTå¾Œã®å‡¦ç†ã¾ã§ã‚‚ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ä¸Šã ã‘ã§å®Ÿè¡Œã§ãã¦ã„ã‚‹ã¨ã„ã†ç‚¹ã§ã™ã€‚

ã“ã‚Œã¯`Wasm`ã¨`Service Worker`ã‚’çµ„ã¿åˆã‚ã›ã¦å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚
å¤§ä½“ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ—ãƒ­ã‚»ã‚¹ã§å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/1880fc0953b1-20230623.png)

Wasmã¯ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼å´ã§ã‚‚å®Ÿè¡Œå¯èƒ½ã§ã™ãŒã€ã‚ãˆã¦Service Workerä¸Šã§å®Ÿè¡Œã—ã¦ã„ã‚‹ã®ã¯ã€URLã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦ãã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆï¼ˆä»‹å…¥ï¼‰ã™ã‚‹ã“ã¨ã§ã€POSTå¾Œã®å‡¦ç†ãªã©ã‚‚ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ä¸Šã§å®Ÿç¾ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã§ã™ã€‚
å…¨ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦Service Workerã‚’ä»‹åœ¨ã•ã›ã‚‹ã“ã¨ã§ã‚ˆã‚Šãƒªã‚¢ãƒ«ãªã‚µãƒ¼ãƒãƒ¼å‡¦ç†ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ä¸Šã§å®Ÿç¾ã§ãã¾ã™ã€‚

ä¾‹ãˆã°ã€ä»¥å‰ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸ`WordPress`ã®Playgroundã‚‚ã“ã®æ–¹æ³•ã§å®Ÿè£…ã•ã‚Œã¦ã„ãŸã‚Šã—ã¾ã™ã€‚

https://developer.wordpress.org/playground/

## ãªãœä½œã£ãŸã‹

ç¾åœ¨ç§ã¯`mosya`ã¨ã„ã†ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ä¸Šã«ã‚ã‚‹ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã ã‘ã§ã„ã‚ã‚“ãªWebåˆ¶ä½œã‚’å­¦ç¿’ã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚
ä»Šå›ç´¹ä»‹ã™ã‚‹æŠ€è¡“ã‚’ä½¿ã†ã“ã¨ã§ã€ã‚ˆã‚Šãƒªã‚¢ãƒ«ãªã‚µãƒ¼ãƒãƒ¼å‡¦ç†ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã ã‘ã§å®Ÿç¾ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€ã‚ˆã‚Šå®Ÿè·µçš„ãªå­¦ç¿’ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¨è€ƒãˆãŸã‹ã‚‰ã§ã™ã€‚

https://mosya.dev/

å­¦ç¿’è€…ã¯è‡ªåˆ†ã§ç’°å¢ƒã‚’ç”¨æ„ã™ã‚‹å¿…è¦ãŒãªã„ã—ã€ã‚³ãƒ¼ãƒ‰ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«åæ˜ ã§ãã‚‹ã®ã§ã€Wasmã‚’ä½¿ã£ãŸå­¦ç¿’ä½“é¨“ã¯ã‹ãªã‚Šè‰¯ã„ã¨ç­†è€…ã¯æ€ã£ã¦ã„ã¾ã™ã€‚

::: message
ã¾ãŸã€Service Workerã¨Wasmã®ç’°å¢ƒã‚’æä¾›ã™ã‚‹ã“ã¨ã§é–‹ç™ºè€…ã«ã¨ã£ã¦ã‚‚å­¦ç¿’å¯¾è±¡ã®è¨€èªã”ã¨ã«ï¼ˆä¾‹ãˆã°Goã§ã‚ã£ãŸã‚ŠPHPã§ã‚ã£ãŸã‚Šï¼‰ã®ã‚µãƒ¼ãƒãƒ¼ã‚’å€‹åˆ¥ã«å»ºã¦ã‚‹å¿…è¦ãŒãªããªã‚‹ã®ã§ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚‚ã—ã‚„ã™ã„ã§ã™ï¼
Service WorkerãŒå‹•ããƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã§ã‚ã‚Œã°ã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚å‹•ã‹ã™ã“ã¨ãŒã§ãã¾ã™ï¼
:::

## Service Workerã¨ã¯ä½•ã‹

ã¾ãšã€Service Workerã¨ã¯ä½•ã‹è»½ããŠã•ã‚‰ã„ã§ã™ã€‚
Service Workerã¨ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã®ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å‹•ä½œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã“ã¨ã§ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªã“ã¨ãŒã§ãã‚‹ã®ãŒç‰¹å¾´ã§ã™ã€‚

- ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã®ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å‹•ä½œã™ã‚‹
- ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆï¼ˆä»‹å…¥ï¼‰ã§ãã‚‹ ğŸ‘ˆã“ã‚ŒãŒã‚¢ãƒ„ã‚¤ï¼ï¼
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ“ä½œã§ãã‚‹
- ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ä¿¡ã§ãã‚‹

ç‰¹ã«ä»Šå›åˆ©ç”¨ã—ãŸæ©Ÿèƒ½ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ä»‹å…¥ã§ãã‚‹ã¨ã„ã†ç‚¹ã§ã™ã€‚
ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼å´ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦ã€Service Workerã‚’ä»‹åœ¨ã•ã›ã‚‹ã“ã¨ã§ã€ã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹å‰ã«Service Workerã§å‡¦ç†ã‚’è¡Œã„ã€ãã®çµæœã‚’ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã«è¿”ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã‚Œã‚’æ´»ç”¨ã™ã‚‹ã¨ã€ã‚µãƒ¼ãƒãƒ¼ã«ä¸€åˆ‡ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¡Œã‚ãªã„ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã“ã¨ãŒã§ãã‚‹ã®ã§ã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚å‹•ä½œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/bad6abe8091c-20230623.png)

## Wasmã¨ã¯ä½•ã‹

Wasmã¨ã¯ä½•ã‹ã«ã¤ã„ã¦ã‚‚è§¦ã‚Œã¦ãŠãã¾ã—ã‚‡ã†ã€‚
Wasmã¨ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ä¸Šã§å‹•ä½œã™ã‚‹ãƒã‚¤ãƒŠãƒªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ã“ã¨ã§ã™ã€‚
Wasmã¯ã•ã¾ã–ã¾ãªç’°å¢ƒã«æŒã¡é‹ã³å¯èƒ½ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã ã‘ã§ã¯ãªãã€Service Workerä¸Šã‚„Node.js
ã¾ãŸæœ€è¿‘ã§ã¯ã€CDNãªã©ã®ã‚¨ãƒƒã‚¸ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ä¸Šã‚„Dockerã§ã‚‚å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¾ãŸæœ€è¿‘ã§ã¯ã€`emscripten`ã¨ã„ã†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¼ã‚’ä½¿ã£ã¦ã€Cã‚„C++ãªã©ã‹ã‚‰ä½œã‚‰ã‚ŒãŸè¨€èªã‚’Wasmã«å¤‰æ›ã™ã‚‹ã“ã¨ã§è¨€èªè‡ªä½“ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã§å‹•ã‹ãã†ã¨ã„ã†é¢ç™½ã„è©¦ã¿ã‚‚ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://ja.wikipedia.org/wiki/Emscripten

`Docker`ã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‰ç›´æ¥Wasmã‚’ç”Ÿæˆã™ã‚‹ã“ã‚“ãªãƒ„ãƒ¼ãƒ«ã‚‚å‡ºã¦ãã¦ã„ã¾ã™ã€‚

https://www.publickey1.jp/blog/23/dockerwebassemblywebcontainer2wasm03.html

è¨€èªã ã‘ã§ãªãã€`PostgreSQL`ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã§å‹•ã‹ã™ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ãŒ`Supabase`ã‹ã‚‰ç™ºè¡¨ã•ã‚Œã¦ã„ãŸã‚Šã‚‚ã—ã¦ã„ã¾ã™ã€‚

https://www.publickey1.jp/blog/22/postgresqlwebpostgre-wasmwebx86.html


## Next.jsã§ã®å®Ÿè£…

å®Ÿéš›ã«ã“ã®ãƒ‡ãƒ¢ã‚’ä½œã‚‹ã«ã‚ãŸã£ã¦ã€Next.jsä¸Šã§ã®å®Ÿè£…ã‚’è¡Œã„ã¾ã—ãŸã€‚
Next.jsã«ãŠã‘ã‚‹å›³ã«ã‚ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

### Service Workerã®ç™»éŒ²

ä»Šå›ã€Service Workerã‚’é–‹ç™ºã—ã‚„ã™ãã™ã‚‹ãŸã‚ã«`next-pwa`ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

https://github.com/shadowwalker/next-pwa

`next-pwa`ã¯`next.config.js`ã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã™ã‚‹ã ã‘ã§Service Workerã‚’ç™»éŒ²ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```js:next.config.js
const withPWA = require("next-pwa")({
  dest: "public",
});

module.exports = withPWA({
  // ã“ã“ã«Next.jsã®è¨­å®šã‚’æ›¸ã
});
```

`workers/index.ts`ã«Service Workerã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã ã‘ã§è‡ªå‹•ã§Service Workerã®ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã£ã¦ãã‚Œã‚‹ã®ã§éå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚

ã¾ãŸã€Service Workerã«å‹ã‚’ã¤ã‘ã‚‹ãŸã‚ã«`tsconfig.json`ã«ä»¥ä¸‹ã®ã‚ˆã†ã«`WebWorker`ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```json:tsconfig.json
{
  "compilerOptions": {
    "lib": ["dom", "dom.iterable", "esnext", "WebWorker"],
  }
}
```

### ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼å´ã®å‡¦ç†

ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼å´ã§ã¯ã‚ã‚‰ã‹ã˜ã‚ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼å´ã§å®Ÿè¡Œã™ã‚‹PHPã®ã‚³ãƒ¼ãƒ‰ã‚’`localForage`ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ã‚³ãƒ¼ãƒ‰ãŒä¿å­˜ã•ã‚Œã‚‹ãŸã³ã«`IndexedDB`ã«ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚

https://github.com/localForage/localForage

`localForage`ã¯`localStorage`ã®ã‚ˆã†ãªä½¿ã„å‹æ‰‹ã§IndexedDBã«å€¤ã‚’ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§éå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚
IndexedDBã«ä¿å­˜ã—ã¦ã„ã‚‹å†…å®¹ã¨ã—ã¦ã¯å®Ÿè¡Œã™ã‚‹iframeã®idã¨ãã“ã§å®Ÿè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¨è¨€èªã®æƒ…å ±ã§ã™ã€‚


```ts
await localforage.setItem(scopeId, {
  code: code,
  lang: "php",
});
```

IndexedDBã¯ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã‹ã‚‰ã§ã‚‚Service Workerã‹ã‚‰ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã®ã§ã“ã®ç‰¹å¾´ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
ã•ã‚‰ã«ä¿å­˜ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿é‡ãŒ`localStorage`ã‚ˆã‚Šã‚‚å¤§ãã„ã®ã‚‚ç‰¹å¾´ã§ã™ã€‚

#### iframeã®æ›´æ–°

IndexedDBã¸ã®ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãŒçµ‚ã‚ã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€iframeã‚’æ›´æ–°ã—ã¾ã™ã€‚
æ›´æ–°ã™ã‚‹ã“ã¨ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦Service Workerã®å‡¦ç†ãŒèµ°ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```ts
await localforage.setItem(scopeId, {
  code: code,
  lang: "php",
});
ref.current?.contentWindow?.location.replace(`/php-mock/playground`);
```

::: message
ã“ã“ã§æ°—ã‚’ã¤ã‘ãŸã„ã®ãŒã€`location.reload()`ã‚’ä½¿ã†ã¨ã€ä¾‹ãˆã°ã€iframeå†…ã§ã€POSTã‚’è¡Œã£ãŸçŠ¶æ…‹ã§ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€POSTãŒå†åº¦è¡Œã‚ã‚Œã¦ã—ã¾ã†ã¨ã„ã†ç‚¹ã§ã™ã€‚
ãªã®ã§ã€`location.replace()`ã‚’ä½¿ã£ã¦ã€iframeã‚’æ›´æ–°ã™ã‚‹ã“ã¨ã§ã€POSTãŒå†åº¦è¡Œã‚ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
:::


### Workerã®å®Ÿè£…

æ¬¡ã«Woerkerå´ã®å®Ÿè£…ã§ã™ã€‚`tsconfig.json`ã«`WebWorker`ã‚’è¿½åŠ ã—ãŸã®ã§ã€`workers/index.ts`ã«ã¦ã€`Service WorkerGlobalScope`ã¨ã„ã†å‹ã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts:workers/index.ts
declare let self: Service WorkerGlobalScope;

self.__WB_DISABLE_DEV_LOGS = true;

self.addEventListener("install", function () {
  self.skipWaiting();
});

self.addEventListener("activate", function (event) {
  event.waitUntil(self.clients.claim()); // Become available to all pages
});
```

Service Workerã§ã¯`self`ã¨ã„ã†ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ã†ã“ã¨ã§ã€Service Workerã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã«å¿œã˜ãŸå‡¦ç†ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

`install`ã¨`activate`ã¯Service Workerã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã«ãŠã‘ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã§ã€`install`ã¯Service WorkerãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸæ™‚ã€`activate`ã¯Service WorkerãŒæœ‰åŠ¹åŒ–ã•ã‚ŒãŸæ™‚ã«å‘¼ã°ã‚Œã¾ã™ã€‚

#### skipWaiting()

`skipWaiting()`ã¯Service Workerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã«å‘¼ã¶ã“ã¨ã§ã€ã™ãã«ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚
ã“ã‚Œã‚’å‘¼ã°ãªã„ã¨ã€Service Workerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¦ã‚‚ã€ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¾ã§Service WorkerãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã›ã‚“ã€‚

#### clients.claim()

`claim()`ã¯`activate`ã‚¤ãƒ™ãƒ³ãƒˆã®ä¸­ã§å‘¼ã¶å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`waitUntil`ã§`claim`ã‚’å‘¼ã¶ã“ã¨ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼å´ã§
`navigator.serviceWorker.controller`ã‚’ä½¿ã£ã¦Service Workerã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã¯ã“ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ä»‹ã—ã¦Service Workerã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
navigator.serviceWorker.addEventListener("controllerchange", () => {
  navigator.serviceWorker.controller?.postMessage({
    // ã“ã“ã«é€ä¿¡å†…å®¹
  });
});
```

### ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¸ã®ä»‹åœ¨å‡¦ç†

Service Workerã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¸ã®ä»‹åœ¨å‡¦ç†ã‚’è¡Œã†ãŸã‚ã«ã¯`fetch`ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ã„ã¾ã™ã€‚
`fetch`ã‚¤ãƒ™ãƒ³ãƒˆã§ã¯XHRã ã‘ã§ã¯ãªãç”»åƒã‚„CSSã€HTMLè‡ªä½“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚‚ä»‹åœ¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»¥ä¸‹ã®å‡¦ç†ã§ã¯`php-mock`ã¨ã„ã†ãƒ‘ã‚¹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ãŸæ™‚ã«ã€`IndexedDB`ã«ä¿å­˜ã—ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦ã€PHPã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç¨®é¡ãŒ`xhr`ãªã©`navigate`ä»¥å¤–ã®å ´åˆã¯ä½•ã‚‚ã›ãšã«çµ‚äº†ã—ã¾ã™ã€‚
ã“ã‚Œã§Rest APIãªã©ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¯ä»‹åœ¨ã—ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚

æ°—ã‚’ã¤ã‘ãŸã„ã®ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ä»‹åœ¨ã™ã‚‹éš›ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è‡ªä½“ã‚’éåŒæœŸå‡¦ç†ã‚’æ›¸ã‘ãªã„ã¨ã„ã†ç‚¹ã§ã™ã€‚éåŒæœŸå‡¦ç†ã‚’ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã«æ›¸ãã¨ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒä»‹åœ¨ã™ã‚‹å‰ã«æ™®é€šã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¡Œã‚ã‚Œã¦ã—ã¾ã†ãŸã‚ã§ã™ã€‚
ãªã®ã§ã€éåŒæœŸå‡¦ç†ãŒå¿…è¦ãªå ´åˆã¯`event.respondWith`ã«æ¸¡ã™é–¢æ•°ã®ä¸­ã§éåŒæœŸå‡¦ç†ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä»Šå›ã®å ´åˆã¯`runPHP`ã¨ã„ã†é–¢æ•°ã§éåŒæœŸå‡¦ç†ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

```ts
self.addEventListener("fetch", function (event) {
  const { request } = event;

  // only navigate request
  if (request.mode !== "navigate") return;

  // ç‰¹å®šã®ãƒ‘ã‚¹ã®æ™‚ã®ã¿ä»‹åœ¨ã™ã‚‹
  if (request.url.includes("php-mock")) {
    const scopeId = request.url.split("/").pop();

    event.respondWith(runPHP(request, scopeId));
  }
});
```

### PHPã®å®Ÿè¡Œ

æ¬¡ã«å…ˆã»ã©å‡ºã¦ããŸ`runPHP`é–¢æ•°ã®å®Ÿè£…ã§ã™ã€‚`runPHP`é–¢æ•°ã§ã¯`IndexedDB`ã«ã‚ã‚‰ã‹ã˜ã‚ä¿å­˜ã—ã¦ã‚ã£ãŸã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¾ã™ã€‚`Wasm`ã®å®Ÿè¡Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨ãªã£ã¦ã„ã‚‹`php.run`ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æƒ…å ±ã‚’æ¸¡ã—ã¦PHPã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

ã“ã“ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ¡ã‚½ãƒƒãƒ‰æƒ…å ±ã‚„ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ãªã©ã‚’æ¸¡ã™ã“ã¨ã§ã€ã‚ˆã‚Šæœ¬ç•ªã®ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ã«è¿‘ã„ã‚‚ã®ã‚’å†ç¾ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
async function runPHP(request: Request, scopeId: string) {
  const storage = (await localforage.getItem(scopeId)) as {
    code: string;
    lang: string;
  };
  if (!storage?.code || !storage?.lang) {
    return new Response("not found", {
      status: 404,
    });
  }
  const { code, lang } = storage;
  const result = await buildPHPWithRequest(
    "8.2",
    code,
    request,
    req.method === "POST" ? await request.text() : undefined
  );
  return new Response(result.body, {
    status: result.status,
    headers: result.headers,
  });
}

export async function buildPHPWithRequest(
  version: Version,
  code: string,
  request: Request,
  body?: string
) {
  const php = await initPHP(version);
  const output = await php.run({
    code: code,
    method: request.method,
    headers: Object.fromEntries(request.headers.entries()),
    body: body,
  });
  const res = new TextDecoder().decode(output.body);
  return {
    status: output.httpStatusCode,
    headers: output.headers,
    body: res,
  };
}
```

### PHPã®Wasmã®ç”Ÿæˆ

PHPã®`wasm`ã‚„ãã‚Œã‚’å®Ÿè¡Œã™ã‚‹`js`ã®ç”Ÿæˆã«ã¯`emscripten`ã¨ã„ã†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¼ãŠã‚ˆã³Dockerã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
è©³ã—ã„å†…å®¹ã«ã¤ã„ã¦ã¯ã“ã®æ–¹ã®è¨˜äº‹ã‚’ã”è¦§ãã ã•ã„ï¼

https://zenn.dev/glassmonkey/articles/ae6cadef80c6c4

## ã¾ã¨ã‚

ä»Šå›ã¯Service Workerã¨Wasmã‚’çµ„ã¿åˆã‚ã›ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ä¸Šã§PHPã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãƒ‡ãƒ¢ã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚
`Wasm`ã ã‘ã§ã¯ãªãã€`Service Worker`ã‚‚åŒæ™‚ã«çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ **ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã®å®Ÿè¡Œãªã©** ã‚ˆã‚Šãƒªã‚¢ãƒ«ãªã‚µãƒ¼ãƒãƒ¼å‡¦ç†ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ä¸Šã§ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
ã“ã®æŠ€è¡“ã‚’å¿œç”¨ã™ã‚Œã°`PHP`ã ã‘ã§ã¯ãªãã€`WordPress`ã‚„`Next.js`ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã ã‘ã§å‹•ã‹ã™ã¨ã„ã†ã®ã‚‚å¯èƒ½ã«ãªã‚Šãã†ãªæ°—ãŒã—ã¾ã™ã€‚


## ãƒ‡ãƒ¢ãƒšãƒ¼ã‚¸

æœ€å¾Œã«ä»Šå›ã®ãƒ‡ãƒ¢ãƒšãƒ¼ã‚¸ã‚’ä½œã£ã¦ã¿ãŸã®ã§ãœã²éŠã‚“ã§ã¿ã¦ãã ã•ã„ã€‚

https://mosya.dev/tools/php

ä»¥ä¸‹ã®gistã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã“ã¨ã§ãƒ•ã‚©ãƒ¼ãƒ ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã¾ã™ã€‚

https://gist.github.com/steelydylan/bf533878d57b6f6d94d52530634b2dd9